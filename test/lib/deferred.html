<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <link rel="stylesheet" href="../qunit/qunit.css" type="text/css" media="screen" />
  <script type="text/javascript" src="../../lib/js/jquery.js"></script>
  <script type="text/javascript" src="../../lib/js/underscore.js"></script>
  <script type="text/javascript" src="../../lib/js/kite.js"></script>
  <script type="text/javascript" src="../qunit/qunit.js"></script>

  <script>new function(_) { // closure
eval(Kite.provides());

// private
function async(fn) {
  stop(); // stop qunit
  setTimeout(function() {
    fn();
    start(); // restart qunit
  }, 0);
}

var AsyncStack = Class.create(function() {
  this.init = function init() {
    this.items = [];
  };

  this.push1 = function push1(item, callback) {
    var self = this;
    async(function() { self.items.push(item); callback(); });
  };

  this.push2 = function push2(item) {
    this.items.push(item);
  };

  this.push3 = function push3(item) {
    var d = new Deferred().pause();
    var self = this;
    async(function() { self.items.push(item); d.restart() })
    return d;
  }
});

test("deferred", function() {
  var d = new Deferred();
  var a = new AsyncStack();
  d.add(
    d.fn(a.push1, [1, d.okFn], a), // asynchronous, not deferred aware
    d.fn(a.push2, [2], a), // synchronous
    d.fn(a.push2, [3], a),
    d.fn(a.push3, [4], a), // asynchronous, deferred aware
    d.fn(a.push2, [5], a),
    function() { same(a.items, [1, 2, 3, 4, 5]); }
  );
  expect(1);
});

test("pass through", function() {
  function increment(i) { return i + 1; }
  function asyncIncrement(i, callback) {
    async(function() { callback(i + 1); });
  }
  function asyncIncrement2(i) {
    var d = new Deferred().pause();
    async(function() { d.restart(i + 1); });
    return d;
  }

  var d = new Deferred();
  d.add(
    d.fn(asyncIncrement, [0, d.okFn]),
    increment,
    increment,
    asyncIncrement2,
    increment,
    function(result) {
      equals(result, 5, "incremented the correct number of times");
    }
  );

  expect(1);
});

test("errors", function() {
  var d = new Deferred();
  expect(1);
});


  }</script>

</head>
<body>
 <h1 id="qunit-header">Deferred Tests</h1>
 <h2 id="qunit-banner"></h2>
 <h2 id="qunit-userAgent"></h2>

 <ol id="qunit-tests"></ol>
</body>
</html>